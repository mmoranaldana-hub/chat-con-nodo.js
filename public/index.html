<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chat con contactos, privados y grupos</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; height:100vh; display:flex; }
    #sidebar { width:280px; background:#f4f4f4; padding:10px; box-sizing:border-box; overflow:auto; border-right:1px solid #ddd; }
    #main { flex:1; display:flex; flex-direction:column; }
    #messages { flex:1; padding:10px; overflow:auto; }
    #input { padding:10px; border-top:1px solid #ddd; display:flex; gap:8px; }
    .item { padding:6px; border-bottom:1px solid #e6e6e6; cursor:pointer; }
    .item:hover { background:#eaeaea; }
    #loginBox, #chatBox { padding:10px; }
    .small { font-size:12px; color:#666; }
    form { display:flex; gap:6px; }
    input[type=text], input[type=password] { padding:6px; flex:1; }
    button { padding:6px 10px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <div id="loginBox">
      <div id="who"></div>
      <div id="auth">
        <h3>Login / Register</h3>
        <input id="username" placeholder="usuario" /><br/><br/>
        <input id="password" placeholder="contraseña" type="password" /><br/><br/>
        <button id="btnRegister">Registrar</button>
        <button id="btnLogin">Entrar</button>
      </div>
      <div id="afterAuth" style="display:none">
        <button id="btnLogout">Cerrar sesión</button>
        <h4>Contactos</h4>
        <div id="contacts"></div>
        <input id="addContactName" placeholder="username a agregar" />
        <button id="btnAddContact">Agregar</button>
        <h4>Grupos</h4>
        <div id="groups"></div>
        <input id="groupName" placeholder="nombre de grupo" />
        <button id="btnCreateGroup">Crear grupo</button>
      </div>
    </div>
  </div>

  <div id="main">
    <div id="messages"></div>
    <div id="input">
      <div style="width:200px">
        <select id="targetType">
          <option value="global">Global</option>
          <option value="private">Privado</option>
          <option value="group">Grupo</option>
        </select>
        <input id="targetId" placeholder="userId o groupId (auto)" style="width:120px" />
      </div>
      <input id="msg" placeholder="escribe..." />
      <button id="btnSend">Enviar</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // client side minimal app
    const socket = io();

    let currentUser = null;
    function api(path, opts) {
      return fetch(path, opts).then(r => r.json());
    }

    // auth
    document.getElementById('btnRegister').onclick = async () => {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const res = await api('/api/register', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username,password})});
      if (res.error) return alert(res.error);
      afterLogin(res);
    };
    document.getElementById('btnLogin').onclick = async () => {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const res = await api('/api/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username,password})});
      if (res.error) return alert(res.error);
      afterLogin(res);
    };
    document.getElementById('btnLogout').onclick = async () => {
      await api('/api/logout', {method:'POST'});
      location.reload();
    };

    async function afterLogin(user) {
      currentUser = user;
      document.getElementById('who').innerText = 'Conectado: ' + user.username + ' (id:' + user.id + ')';
      document.getElementById('auth').style.display = 'none';
      document.getElementById('afterAuth').style.display = '';
      // authenticate socket
      socket.emit('auth', { userId: user.id });
      loadContacts();
      loadGroups();
      loadGlobalMessages();
    }

    // contacts
    async function loadContacts(){
      const list = await api('/api/contacts');
      const cont = document.getElementById('contacts');
      cont.innerHTML = '';
      list.forEach(c => {
        const d = document.createElement('div');
        d.className = 'item';
        d.innerText = c.username + ' (id:'+c.id+')';
        d.onclick = () => { document.getElementById('targetType').value='private'; document.getElementById('targetId').value=c.id; loadPrivate(c.id); };
        cont.appendChild(d);
      });
    }
    document.getElementById('btnAddContact').onclick = async () => {
      const username = document.getElementById('addContactName').value;
      if (!username) return;
      const res = await api('/api/add-contact', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({contactUsername: username})});
      if (res.error) return alert(res.error);
      loadContacts();
    };

    // groups
    async function loadGroups(){
      const list = await api('/api/groups');
      const cont = document.getElementById('groups');
      cont.innerHTML = '';
      list.forEach(g => {
        const d = document.createElement('div');
        d.className = 'item';
        d.innerText = g.name + ' (id:'+g.id+')';
        d.onclick = () => { document.getElementById('targetType').value='group'; document.getElementById('targetId').value=g.id; loadGroup(g.id); };
        cont.appendChild(d);
      });
    }
    document.getElementById('btnCreateGroup').onclick = async () => {
      const name = document.getElementById('groupName').value;
      if (!name) return;
      const res = await api('/api/create-group', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, members:[]})});
      if (res.error) return alert(res.error);
      loadGroups();
    };

    // messages loading
    async function loadGlobalMessages(){
      const msgs = await api('/api/messages?type=global');
      renderMessages(msgs);
    }
    async function loadPrivate(withId){
      const msgs = await api('/api/messages?type=private&with=' + withId);
      renderMessages(msgs);
    }
    async function loadGroup(groupId){
      const msgs = await api('/api/messages?type=group&group_id=' + groupId);
      renderMessages(msgs);
    }

    function renderMessages(msgs){
      const box = document.getElementById('messages');
      box.innerHTML = '';
      msgs.forEach(m => {
        const el = document.createElement('div');
        el.innerHTML = '<b>'+ (m.from_username||'anon') + ':</b> ' + (m.content||'');
        box.appendChild(el);
      });
      box.scrollTop = box.scrollHeight;
    }

    // send
    document.getElementById('btnSend').onclick = async () => {
      const content = document.getElementById('msg').value;
      if (!content) return;
      const type = document.getElementById('targetType').value;
      const targetId = document.getElementById('targetId').value || null;
      if (type === 'global') {
        socket.emit('send_message', { content });
      } else if (type === 'private') {
        socket.emit('send_message', { content, toId: parseInt(targetId) });
      } else if (type === 'group') {
        socket.emit('send_message', { content, groupId: parseInt(targetId) });
      }
      document.getElementById('msg').value = '';
    };

    // socket listener
    socket.on('new_message', (msg) => {
      // simple: if chat shown corresponds to the message, append; otherwise ignore
      const currentType = document.getElementById('targetType').value;
      const targetId = document.getElementById('targetId').value;
      let shouldShow = false;
      if (!msg.group_id && !msg.to_id) { // global
        if (currentType === 'global') shouldShow = true;
      } else if (msg.group_id) {
        if (currentType === 'group' && String(msg.group_id) === String(targetId)) shouldShow = true;
      } else if (msg.to_id) {
        // private message: show if current private with == other user
        if (currentType === 'private' && (String(msg.from_id) === String(targetId) || String(msg.to_id) === String(targetId))) shouldShow = true;
      }
      if (shouldShow) {
        const box = document.getElementById('messages');
        const el = document.createElement('div');
        el.innerHTML = '<b>'+ (msg.from_username||'anon') + ':</b> ' + (msg.content||'');
        box.appendChild(el);
        box.scrollTop = box.scrollHeight;
      }
    });

    // try to detect session on load
    (async () => {
      try {
        // try to load contacts to see if logged in
        const res = await fetch('/api/contacts');
        if (res.status === 200) {
          // fetch user info: contacts response ok means logged in
          const cs = await res.json();
          // get username from / whoami not implemented — better rely on login flow. Show afterAuth if contacts returned.
          document.getElementById('auth').style.display = 'none';
          document.getElementById('afterAuth').style.display = '';
          loadContacts();
          loadGroups();
          loadGlobalMessages();
          // no user id for socket auth — prompt user to login again for proper socket auth
        }
      } catch(e){}
    })();
  </script>
</body>
</html>

