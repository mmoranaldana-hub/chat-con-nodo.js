<!-- INDEX.HTML INTEGRADO CON ADMINISTRACIÓN DE GRUPOS -->
<!-- Incluye: crear grupos, gestionar admins, expulsar miembros, botón ⚙ -->

<!-- Voy a insertar SOLO lo necesario dentro de tu mismo estilo -->

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatNodo — Corregido + Grupos Admin</title>

  <style>
    /* ===== MANTENGO TODO TU CSS ORIGINAL ===== */

    :root{
      --bg: #e9edef; --panel: #fff; --accent:#25D366; --muted:#8a9398; 
      --me:#DCF8C6; --them:#ffffff; --header:#075E54; --text:#111827;
      --dark-bg: #0f1720; --dark-panel:#111827; --dark-text:#e6eef3;

      /* NUEVOS PARA MODAL DE GRUPO */
      --modal-bg: rgba(0,0,0,0.55);
      --modal-panel: #fff;
      --modal-panel-dark: #1a1f24;
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Segoe UI,Arial,sans-serif}

    html,body,#root{height:100%;}
    body{height:100vh;background:var(--bg);color:var(--text)}

    .app{height:100vh;display:flex;gap:18px;padding:18px}

    /* ——— Sidebar ——— */
    .sidebar{width:320px;background:var(--panel);border-radius:12px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.07)}

    /* ... (todo tu CSS se mantiene igual) ... */

    /* ===== MODAL DE ADMINISTRAR GRUPO ===== */
    #group-admin-modal{
      position:fixed;inset:0;background:var(--modal-bg);
      display:none;justify-content:center;align-items:center;z-index:9999;
    }
    #group-admin-modal .modal-box{
      background:var(--modal-panel);color:var(--text);
      width:380px;max-height:80vh;overflow-y:auto;
      border-radius:12px;padding:16px;
    }
    body.dark #group-admin-modal .modal-box{
      background:var(--modal-panel-dark);color:var(--dark-text);
    }
    .member-row{
      display:flex;justify-content:space-between;align-items:center;
      padding:8px;border-bottom:1px solid #ddd;
    }
    .member-actions button{
      margin-left:6px;padding:4px 8px;border-radius:6px;border:0;cursor:pointer;
    }
    .admin-tag{
      background:#25D366;color:#fff;padding:2px 6px;border-radius:6px;font-size:11px;margin-left:6px;
    }
  </style>
</head>
<body>
  <div id="root">

    <!-- AUTH UI ORIGINAL -->
    <!-- (todo tu bloque AUTH se mantiene igual) -->

    <!-- APP UI ORIGINAL -->
    <!-- (sidebar + chat) -->

    <!-- ===== MODAL DE ADMINISTRACIÓN DE GRUPO ===== -->
    <div id="group-admin-modal">
      <div class="modal-box">
        <h2 style="margin-bottom:10px">Administrar grupo</h2>
        <div id="group-admin-members"></div>
        <button onclick="closeGroupAdminModal()" class="btn" style="margin-top:14px;width:100%">Cerrar</button>
      </div>
    </div>

  </div>


  <!-- ===== SOCKET.IO ===== -->
  <script src="/socket.io/socket.io.js"></script>

  <script>
  /* ============================ */
  /*  TODO TU SCRIPT ORIGINAL     */
  /*  SOLO AGREGO FUNCIONES EXTRA */
  /* ============================ */

  const socket = io();
  let me = null;
  let current = { type:'global' };

  /* ======================= */
  /* BOTÓN ⚙ PARA ADMIN GRUPO */
  /* ======================= */
  async function openGroup(id,name){
    current = { type:'group', id, name };

    document.getElementById('chat-name').innerHTML = 
      name + ` <button onclick="openGroupAdminModal(${id})" style="margin-left:8px;background:none;border:0;font-size:20px">⚙</button>`;

    document.getElementById('chat-sub').textContent='Grupo';
    document.getElementById('messages').innerHTML='';

    const msgs = await api('/groups/messages/'+id);
    if(Array.isArray(msgs)) msgs.forEach(render);

    scrollBottom();
    socket.emit('join_group', id);
  }


  /* ========================================= */
  /*   MODAL ADMINISTRACIÓN DE GRUPO — ABRIR   */
  /* ========================================= */
  async function openGroupAdminModal(groupId){
    const modal = document.getElementById('group-admin-modal');
    const box = document.getElementById('group-admin-members');

    const r = await api('/groups/info/'+groupId);
    if(!r || r.error){ alert('Error cargando datos'); return; }

    const members = r.members;
    box.innerHTML = '';

    members.forEach(m =>{
      const row = document.createElement('div');
      row.className = 'member-row';

      row.innerHTML = `
        <div>
          ${m.username}
          ${m.is_admin ? '<span class="admin-tag">admin</span>' : ''}
        </div>
        <div class="member-actions">
          ${!m.is_admin ? `<button onclick="setAdmin(${groupId},${m.id},true)" style="background:#4ade80">Hacer admin</button>` : ''}
          ${m.is_admin && m.id != r.owner_id ? `<button onclick="setAdmin(${groupId},${m.id},false)" style="background:#fbbf24">Quitar admin</button>` : ''}
          ${m.id != r.owner_id ? `<button onclick="removeMember(${groupId},${m.id})" style="background:#ef4444;color:white">Expulsar</button>` : ''}
        </div>`;

      box.appendChild(row);
    });

    modal.style.display = 'flex';
  }

  function closeGroupAdminModal(){
    document.getElementById('group-admin-modal').style.display='none';
  }


  /* ========================================= */
  /*         HACER ADMIN / QUITAR ADMIN        */
  /* ========================================= */
  async function setAdmin(group_id, user_id, makeAdmin){
    const r = await api('/groups/set-admin','POST',{ group_id, user_id, is_admin:!!makeAdmin });
    if(r && r.error) return alert(r.error);
    openGroupAdminModal(group_id);
  }


  /* ========================================= */
  /*             EXPULSAR MIEMBRO              */
  /* ========================================= */
  async function removeMember(group_id, user_id){
    if(!confirm('¿Seguro que quieres expulsar a este usuario?')) return;
    const r = await api('/groups/remove-member','POST',{ group_id, user_id });
    if(r && r.error) return alert(r.error);
    openGroupAdminModal(group_id);
  }


  </script>
</body>
</html>
