<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatNodo ‚Äî WhatsApp Style</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="/css/style.css" />

  <style>
    /* Mini-reset + fuentes */
    :root{
      --bg:#e9edef; --panel:#ffffff; --accent:#25D366; --muted:#8a9398;
      --me:#DCF8C6; --them:#ffffff; --header:#075E54; --text:#111827;
      --sidebar:#f6f6f6;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif}
    html,body,#app{height:100%;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    /* Layout */
    #app{height:100vh;display:flex;align-items:stretch;gap:18px;padding:18px}

    /* Sidebar */
    .sidebar{width:340px;background:var(--sidebar);border-radius:12px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.07)}
    .sidebar .top{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #e6e6e6}
    .brand{display:flex;gap:12px;align-items:center}
    .brand h1{font-size:20px;color:var(--header);font-weight:700}
    .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#cfe9d6,#8fd6a0);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .me-info{display:flex;flex-direction:column}
    .me-info .name{font-weight:600}
    .me-info .small{font-size:12px;color:var(--muted)}

    /* Search */
    .search{padding:10px 14px;border-bottom:1px solid #eee}
    .search input{width:100%;padding:10px;border-radius:20px;border:1px solid #e5e5e5;background:#fff}

    /* List */
    .list{overflow:auto;padding:10px 8px;flex:1}
    .item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:8px;cursor:pointer}
    .item:hover{background:#f4f7f6}
    .item .meta{flex:1;display:flex;flex-direction:column}
    .item .meta .title{font-weight:600}
    .item .meta .desc{font-size:13px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.online{background:#34d859}
    .dot.offline{background:#cfcfcf}

    /* Main chat area */
    .chat{flex:1;display:flex;flex-direction:column;border-radius:12px;background:#fff;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .chat .head{display:flex;align-items:center;gap:12px;padding:14px;border-bottom:1px solid #eee;background:linear-gradient(90deg,var(--header),#128C7E);color:#fff}
    .chat .head .title{font-weight:700}
    .chat .messages{flex:1;padding:18px;overflow:auto;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.03"><rect width="200" height="200" fill="%23ffffff"/></svg>') #eaf3ee}
    .msg{max-width:72%;padding:10px 12px;border-radius:8px;margin-bottom:8px;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
    .msg.me{margin-left:auto;background:var(--me)}
    .msg.other{background:var(--them)}
    .msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid #f0f0f0;align-items:center}
    .composer input{flex:1;padding:10px;border-radius:20px;border:1px solid #e6e6e6}
    .btn{background:var(--header);color:#fff;border:none;padding:9px 14px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--header);border:1px solid rgba(255,255,255,0.12)}

    /* Emoji picker small */
    .emoji-picker{position:absolute;right:40px;bottom:90px;background:#fff;padding:8px;border:1px solid #eee;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);display:grid;grid-template-columns:repeat(8,1fr);gap:6px;z-index:50}
    .emoji{font-size:20px;cursor:pointer;padding:6px;text-align:center}
    /* Responsive */
    @media(max-width:900px){
      #app{padding:8px}
      .sidebar{display:none}
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="top">
        <div class="brand">
          <div class="avatar">CN</div>
          <div>
            <h1>ChatNodo</h1>
            <div style="font-size:12px;color:var(--muted)">Node + Socket.io</div>
          </div>
        </div>
        <div>
          <button id="new-group" class="btn">Nuevo</button>
        </div>
      </div>

      <div class="search">
        <input id="search" placeholder="Buscar contactos o grupos..." />
      </div>

      <div style="padding:10px;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;gap:10px">
        <div class="avatar" id="me-avatar">ME</div>
        <div class="me-info">
          <div class="name" id="me-name">Invitado</div>
          <div class="small" id="me-presence">Desconectado</div>
        </div>
      </div>

      <div class="list" id="contacts-list">
        <!-- contactos se inyectan aqu√≠ -->
      </div>
    </aside>

    <!-- CHAT AREA -->
    <main class="chat">
      <div class="head">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="avatar" id="chat-avatar">G</div>
          <div>
            <div class="title" id="chat-name">Global</div>
            <div style="font-size:13px" id="chat-sub">Chat p√∫blico</div>
          </div>
        </div>
      </div>

      <div class="messages" id="messages">
        <!-- mensajes -->
      </div>

      <div class="composer">
        <button id="emoji-btn" class="btn.ghost">üòÄ</button>
        <input id="message-input" placeholder="Escribe un mensaje..." />
        <button id="send-btn" class="btn">Enviar</button>
      </div>
    </main>
  </div>

  <!-- Emoji picker -->
  <div id="emoji-picker" class="emoji-picker" style="display:none"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ====== Client minimal integrado con tu backend ======
    const socket = io();
    let me = null;
    let current = {type:"global"};

   async function api(path, method = "GET", body) {
  const opts = {
    method,
    headers: {},
    credentials: "include"   // üî• NECESARIO PARA QUE FUNCIONE LOGIN Y TODO
  };

  if (body) {
    opts.headers["Content-Type"] = "application/json";
    opts.body = JSON.stringify(body);
  }

  const res = await fetch("/api" + path, opts);
  return res.json();
}


    // UI refs
    const contactsList = document.getElementById("contacts-list");
    const messagesEl = document.getElementById("messages");
    const meNameEl = document.getElementById("me-name");
    const mePresenceEl = document.getElementById("me-presence");
    const chatNameEl = document.getElementById("chat-name");
    const chatSubEl = document.getElementById("chat-sub");
    const input = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const emojiBtn = document.getElementById("emoji-btn");
    const emojiPicker = document.getElementById("emoji-picker");

    const EMOJIS = ["üòÄ","üòÇ","üòç","üòÖ","üòé","üëç","üî•","‚ù§Ô∏è","üéâ","ü§ù","üëè","ü§ñ","üôå","üò¢","üò°","ü§©"];

    // build emoji picker
    function buildEmojis(){
      emojiPicker.innerHTML = "";
      EMOJIS.forEach(e=>{
        const d = document.createElement("div");
        d.className="emoji";
        d.textContent = e;
        d.onclick = ()=> { input.value += e; emojiPicker.style.display="none"; input.focus(); }
        emojiPicker.appendChild(d);
      });
    }
    buildEmojis();

    emojiBtn.addEventListener("click", ()=> {
      emojiPicker.style.display = emojiPicker.style.display === "none" ? "grid" : "none";
    });

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", (e)=> { if (e.key==="Enter") sendMessage(); });

    async function loadMe(){
      const r = await api("/me");
      me = r.user;
      meNameEl.textContent = me ? me.username : "Invitado";
      mePresenceEl.textContent = me ? "En l√≠nea" : "Desconectado";
      if (me) socket.emit("online", me.id);
    }

    async function loadContacts(){
      const cs = me ? await api("/contacts") : [];
      contactsList.innerHTML = "";
      // global entry
      const g = document.createElement("div");
      g.className="item";
      g.innerHTML = '<div class="meta"><div class="title">Global</div><div class="desc">Chat p√∫blico</div></div>';
      g.onclick = ()=> openGlobal();
      contactsList.appendChild(g);

      cs.forEach(c=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `<div style="width:44px"><div class="avatar" style="background:#cdebdc">${c.username[0].toUpperCase()}</div></div>
                        <div class="meta"><div class="title">${c.username} ${c.online?'<span style="color:#34d859;font-size:12px">‚óè</span>':''}</div>
                        <div class="desc">${c.online? 'En l√≠nea' : 'Desconectado'}</div></div>`;
        el.onclick = ()=> openPrivate(c.id,c.username);
        contactsList.appendChild(el);
      });
    }

    async function loadGlobal(){
      current = {type:"global"};
      chatNameEl.textContent = "Global";
      chatSubEl.textContent = "Chat p√∫blico";
      messagesEl.innerHTML = "";
      const msgs = await api("/messages");
      msgs.forEach(render);
      scroll();
    }

    function render(m){
      // unify shape for private/group/global messages
      const el = document.createElement("div");
      const isMe = (me && (m.user_id === me.id || m.from === me.id));
      el.className = "msg " + (isMe ? "me":"other");
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = (m.username || ("User "+(m.from||m.user_id || ""))) + " ‚Ä¢ " + new Date(m.created_at).toLocaleString();
      const body = document.createElement("div");
      body.textContent = m.text || m.message || m.msg || "";
      el.appendChild(meta);
      el.appendChild(body);
      messagesEl.appendChild(el);
    }

    function scroll(){ messagesEl.scrollTop = messagesEl.scrollHeight; }

    async function sendMessage(){
      const text = input.value.trim();
      if (!text) return;
      if (current.type==="global"){
        const r = await api("/messages","POST",{ text });
        socket.emit("message", r);
        render(r);
      } else if (current.type==="private"){
        await api("/private/send","POST",{ to: current.withId, text });
      } else if (current.type==="group"){
        await api("/groups/send","POST",{ group_id: current.id, text });
      }
      input.value="";
      scroll();
    }

    function openPrivate(id, name){
      current = {type:"private", withId:id};
      chatNameEl.textContent = name;
      chatSubEl.textContent = "Chat privado";
      messagesEl.innerHTML = "";
      api("/private/"+id).then(arr=>{ arr.forEach(render); scroll(); });
      socket.emit("join_private",{ me: me.id, other: id });
    }

    function openGlobal(){ loadGlobal(); socket.emit("join_private",{me:me?me.id:0, other:0}); }

    socket.on("message", (m)=> { if (current.type==="global"){ render(m); scroll(); } });
    socket.on("private_message", (m)=> { if (current.type==="private" && (m.from===current.withId || m.to===current.withId)){ render(m); scroll(); }});
    socket.on("group_message", (m)=> { if (current.type==="group" && m.group_id===current.id){ render(m); scroll(); }});
    socket.on("presence_update", (p)=> { loadContacts(); });

    // init
    (async ()=> {
      await loadMe();
      await loadContacts();
      await loadGlobal();
    })();
  </script>
</body>
</html>
