<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatNodo ‚Äî Corregido</title>
  <style>
    :root{
  --bg: #e9edef; 
  --panel: #fff; 
  --accent:#1e90ff; 
  --muted:#8a9398; 

  /* ‚úÖ GLOBOS AZULES */
  --me:#1e90ff;        /* Azul fuerte (t√∫) */
  --them:#dbeafe;      /* Azul claro (otros) */

  --header:#1e90ff; 
  --text:#111827;

  --dark-bg: #0f1720; 
  --dark-panel:#111827; 
  --dark-text:#e6eef3;

    --chat-bg: #f0f2f5;
  --chat-bg-dark: #0b1220;

  --msg-me-dark: #2563eb;      /* Azul fuerte oscuro */
  --msg-other-dark: #1f2937;  /* Gris oscuro mensajes ajenos */

  --header-dark: #1e293b;     /* Header oscuro visible */

}


    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif}
    html,body,#root{height:100%;}
    body{height:100vh;background:var(--bg);color:var(--text)}

    /* App layout */
    .app{height:100vh;display:flex;gap:18px;padding:18px}

    /* Sidebar */
    .sidebar{width:320px;background:var(--panel);border-radius:12px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.07)}
    .top{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid #eee}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#cfe9d6,#8fd6a0);color:#fff;font-weight:700}
    .search{padding:10px;border-bottom:1px solid #eee}
    .search input{width:100%;padding:8px;border-radius:20px;border:1px solid #e6e6e6}

    .profile{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid #eee}
    .me-avatar{width:56px;height:56;border-radius:50%;background:#ddd;display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden}
    .me-avatar img{width:100%;height:100%;object-fit:cover}
    .me-info .name{font-weight:700}
    .small{font-size:12px;color:var(--muted)}

    .tools{display:flex;gap:8px;padding:10px;border-bottom:1px solid #f0f0f0}
    .list{overflow:auto;padding:8px;flex:1;min-height:0} /* min-height:0 so it can scroll */
    .item{
  display:flex;
  gap:12px;                /* ‚úÖ M√°s separaci√≥n entre foto y texto */
  align-items:center;
  padding:8px 10px;
  border-radius:10px;
  cursor:pointer;
}

.item .me-avatar{
  min-width: 44px;         /* ‚úÖ Evita que la foto se encime */
  min-height: 44px;
  width: 44px;
  height: 44px;
  font-size: 14px;
}

    .item:hover{background:#f4f7f6}
    .item .meta{flex:1}
    .badge{background:#ff3b30;color:#fff;padding:2px 6px;border-radius:12px;font-size:12px}

    /* Chat area */
    .chat{flex:1;display:flex;flex-direction:column;border-radius:12px;background:var(--panel);overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .chat .head{display:flex;align-items:center;gap:12px;padding:14px;border-bottom:1px solid #eee;background:linear-gradient(90deg,var(--header),#128C7E);color:#fff}
    /* Fondo del √°rea de mensajes */
.messages {
  flex: 1;
  padding: 16px;
  overflow: auto;
  background: var(--chat-bg);
  min-height: 0;
}

.msg {
  max-width: 55%;   /* ‚úÖ M√°s angosto */
  padding: 8px 10px;
  border-radius: 10px;
  margin-bottom: 6px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.08);
  word-break: break-word;
  font-size: 14px;
  line-height: 1.4;
}

.msg.me {
  border-bottom-right-radius: 2px;
}

.msg.other {
  border-bottom-left-radius: 2px;
}

.msg .meta {
  font-size: 11px;
  margin-bottom: 4px;
  opacity: 0.85;
}

/* ‚úÖ Nombre y hora PROPIOS (sobre azul fuerte) */
.msg.me .meta{
  color: rgba(255,255,255,0.85);
}

/* ‚úÖ Nombre y hora de OTROS (sobre azul claro) */
.msg.other .meta{
  color: #1e293b;
}


/* Mensajes */
.msg.me {
  margin-left: auto;
  background: var(--me);   /* Azul fuerte */
  color: white;
}

.msg.other {
  background: var(--them); /* Azul claro */
  color: #1e293b;
}


/* Modo oscuro */
body.dark .messages {
  background: var(--chat-bg-dark);
}

body.dark .msg.me {
  background: var(--msg-me-dark);
  color: white;
}

body.dark .msg.other {
  background: var(--msg-other-dark);
  color: #e5e7eb;
}

body.dark .msg {
  color: var(--dark-text);
}
body.dark .msg.me .meta{
  color: rgba(255,255,255,0.9);
}

body.dark .msg.other .meta{
  color: #cbd5f5;
}

    
    .msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px}

    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid #f0f0f0;align-items:center}
    .composer input{flex:1;padding:10px;border-radius:20px;border:1px solid #e6e6e6}
    .btn{background:var(--header);color:#fff;border:none;padding:9px 14px;border-radius:8px;cursor:pointer}

    /* dark mode */
    body.dark{background:var(--dark-bg);color:var(--dark-text)}
    body.dark .panel{background:var(--dark-panel)}

    @media(max-width:900px){
      .app{flex-direction:column;padding:8px}
      .sidebar{width:100%;order:2}
      .chat{order:1}
    }
    /* ============================
   RESPONSIVE ‚Äî M√ìVILES (nuevo)
   ============================ */

@media(max-width: 600px){
  
  /* Estructura principal */
  .app{
    flex-direction: column;
    padding: 6px;
    gap: 6px;
  }

  .sidebar{
    width: 100% !important;
    border-radius: 10px;
  }

  .chat{
    width: 100%;
    border-radius: 10px;
  }

  /* Top bar compacta */
  .top{
    padding: 8px;
  }

  .logo{
    width: 36px;
    height: 36px;
    font-size: 16px;
  }

  .search input{
    padding: 7px;
    font-size: 14px;
  }

  /* Perfil */
  .me-avatar{
    width: 46px;
    height: 46px;
  }

  .profile{
    padding: 10px;
  }

  /* Lista */
  .item{
    padding: 6px;
    gap: 8px;
  }

  /* Chat header */
  .chat .head{
    padding: 10px;
    gap: 8px;
  }

  /* √Årea de mensajes */
  .messages{
    padding: 10px;
  }

  .msg{
    max-width: 90% !important;
    font-size: 14px;
    padding: 8px 10px;
  }

  .msg .meta{
    font-size: 11px;
  }

  /* Composer */
  .composer{
    padding: 8px;
    gap: 6px;
  }

  .composer input{
    padding: 9px;
    font-size: 14px;
  }

  .btn{
    padding: 8px 10px !important;
    font-size: 14px;
  }

  /* Emoji picker */
  #emoji-picker{
    right: 10px !important;
    bottom: 80px !important;
    transform: scale(0.9);
  }
  /* ============================
   ESTILO WHATSAPP PARA M√ìVIL
   ============================ */
@media(max-width: 600px){

  /* Oculta sidebar por defecto */
  .sidebar{
    position: fixed;
    top: 0;
    left: -100%;
    width: 75%;
    height: 100%;
    background: var(--panel);
    z-index: 50;
    transition: left 0.25s ease;
  }

  /* Cuando est√° abierta */
  .sidebar.open{
    left: 0;
  }

  /* Cubre el resto con fondo oscuro */
  #overlay{
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.4);
    z-index:40;
  }

  #overlay.show{
    display:block;
  }

  /* El chat ocupa toda la pantalla */
  .chat{
    width:100%;
    height:100vh;
  }

  /* Bot√≥n ‚ò∞ visible */
  .mobile-only{
    display:block !important;
  }

  /* Ocultar t√≠tulo de app para m√°s espacio */
  .brand{
    display:none;
  }

  /* Ajustes menores */
  .app{
    padding:0;
    gap:0;
  }
}

}

  </style>
</head>
<body>
  <div id="root">
    <div id="overlay"></div>
    <!-- AUTH -->
    <div id="auth" style="display:none;max-width:480px;margin:30px auto;padding:18px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.06)">
      <h2 id="auth-title">Inicia sesi√≥n</h2>
      <div id="login-form">
        <input id="login-username" placeholder="Usuario" style="width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid #ddd" />
        <input id="login-password" type="password" placeholder="Contrase√±a" style="width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid #ddd" />
        <div style="display:flex;gap:8px"><button class="btn" id="login-btn">Entrar</button><button id="show-register" style="padding:9px 14px">Reg√≠strate</button></div>
      </div>
      <div id="register-form" style="display:none;margin-top:10px">
        <input id="reg-username" placeholder="Usuario" style="width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid #ddd" />
        <div style="position:relative">
  <input id="reg-password" type="password" placeholder="Contrase√±a"
    style="width:100%;padding:10px;padding-right:40px;margin-bottom:6px;border-radius:8px;border:1px solid #ddd" />

  <button id="toggle-pass" type="button"
    style="position:absolute;right:8px;top:8px;background:none;border:none;cursor:pointer;font-size:18px">
    üëÅÔ∏è
  </button>
</div>

<!-- Reglas de contrase√±a -->
<div id="password-rules" style="font-size:13px;margin-bottom:10px;color:#555">
  <div id="rule-length">‚óè M√≠nimo 8 caracteres</div>
  <div id="rule-upper">‚óè Una may√∫scula (A-Z)</div>
  <div id="rule-lower">‚óè Una min√∫scula (a-z)</div>
  <div id="rule-number">‚óè Un n√∫mero (0-9)</div>
  <div id="rule-symbol">‚óè Un car√°cter especial (!@#$)</div>
</div>

<!-- Medidor de fuerza -->
<div style="margin-bottom:12px">
  <div style="height:6px;width:100%;background:#ddd;border-radius:10px;overflow:hidden">
    <div id="strength-bar" style="height:100%;width:0%;background:red;transition:.3s"></div>
  </div>
  <small id="strength-text" style="font-size:12px;color:#555">Fuerza: D√©bil</small>
</div>

        <div style="display:flex;gap:8px"><button class="btn" id="reg-btn">Crear cuenta</button><button id="show-login" style="padding:9px 14px">Iniciar sesi√≥n</button></div>
      </div>
      <div id="auth-msg" style="color:#b00;margin-top:8px"></div>
    </div>

    <!-- APP -->
    <div class="app" id="app" style="display:none;min-height:0">
      <aside class="sidebar panel">
        <div class="top">
          <div class="brand"><div class="logo">CN</div><div><strong>ChatNodo</strong><div class="small">Node + Socket.io</div></div></div>
          <div style="display:flex;gap:8px">
            <button id="toggle-dark" title="Modo oscuro" style="padding:8px;border-radius:8px">üåì</button>
          </div>
        </div>

        <div class="search"><input id="search" placeholder="Buscar contactos o grupos..." /></div>

        <div class="profile">
          <label class="me-avatar" id="me-avatar" title="tu foto de perfil">
            <img id="me-avatar-img" src="" alt="" style="display:none" />
            <div id="me-avatar-initial">ME</div>
          </label>
          <div style="flex:1">
            <div class="me-info"><div id="me-name">Invitado</div><div class="small" id="me-presence">Desconectado</div></div>
            <div style="margin-top:6px;display:flex;gap:6px;align-items:center">
              <input id="avatar-file" type="file" accept="image/*" style="display:none" />
              <button id="change-avatar" class="btn" style="padding:6px 10px">Cambiar foto</button>
              <button id="edit-desc" style="padding:6px 10px">Editar descripci√≥n</button>
            </div>
            <div id="me-desc" class="small" style="margin-top:6px;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></div>
          </div>
        </div>

        <div class="tools">
          <input id="add-contact-name" placeholder="Agregar contacto" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd" />
          <button id="add-contact-btn" class="btn">A√±adir</button>
        </div>

        <div style="padding:10px;border-bottom:1px solid #f0f0f0;display:flex;gap:8px">
          <input id="new-group-name" placeholder="Crear grupo (nombre)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd" />
          <button id="create-group-btn" class="btn">Crear</button>
        </div>

        <div class="list" id="contacts-list">
          <!-- dynamic list -->
        </div>
      </aside>

      <main class="chat panel">
        <div class="head">
          <button id="mobile-menu-btn" class="mobile-only" style="display:none;font-size:22px;background:none;border:none;color:white;">‚ò∞</button>
          <div style="display:flex;align-items:center;gap:12px">
            <div class="me-avatar" id="chat-avatar">G</div>
            <div><div id="chat-name" style="font-weight:700">Global</div><div class="small" id="chat-sub">Chat p√∫blico</div></div>
          </div>
          <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
            <div id="user-count" class="small">0 online</div>
            <button id="logout-btn" class="btn" style="background:rgba(255,255,255,0.12);border:0">Salir</button>
          </div>
        </div>

        <div class="messages" id="messages"></div>

        <div class="composer">
  <input type="file" id="file-input" style="display:none" />
  <button id="file-btn" class="btn">üìé</button>
  <button id="emoji-btn" class="btn">üòÄ</button>
  <input id="message-input" placeholder="Escribe un mensaje..." />
  <button id="send-btn" class="btn">Enviar</button>
        </div>
      </main>
    </div>
  </div>

  <div id="emoji-picker" style="display:none;position:fixed;right:24px;bottom:80px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.12)"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let me = null; let current = { type: 'global' };
    const EMOJIS = ['üòÄ','üòÇ','üòç','üòÖ','üòé','üëç','üî•','‚ù§Ô∏è','üéâ','ü§ù','üëè','ü§ñ','üôå','üò¢','üò°','ü§©'];

    async function api(path, method='GET', body){
      const opts = { method, headers: {}, credentials: 'include' };
      if(body){ opts.headers['Content-Type']='application/json'; opts.body = JSON.stringify(body); }
      try{ const res = await fetch('/api'+path, opts); return await res.json(); }catch(e){ console.error('API error',e); return null; }
    }

    // AUTH UI
    document.getElementById('show-register').addEventListener('click', ()=>{ document.getElementById('login-form').style.display='none'; document.getElementById('register-form').style.display='block'; });
    document.getElementById('show-login').addEventListener('click', ()=>{ document.getElementById('login-form').style.display='block'; document.getElementById('register-form').style.display='none'; });

    document.getElementById('login-btn').addEventListener('click', async ()=>{
      const u = document.getElementById('login-username').value.trim(); const p = document.getElementById('login-password').value.trim();
      if(!u||!p){ document.getElementById('auth-msg').textContent='Completa usuario y contrase√±a'; return; }
      const r = await api('/login','POST',{ username:u, password:p });
      if(!r){ document.getElementById('auth-msg').textContent='Error servidor'; return; }
      if(r.error){ document.getElementById('auth-msg').textContent = r.error; return; }
      await initAfterAuth();
    });
    // ===============================
// CONTRASE√ëA SEGURA + MEDIDOR
// ===============================
const regPassword = document.getElementById("reg-password");
const togglePass = document.getElementById("toggle-pass");

const rules = {
  length: document.getElementById("rule-length"),
  upper: document.getElementById("rule-upper"),
  lower: document.getElementById("rule-lower"),
  number: document.getElementById("rule-number"),
  symbol: document.getElementById("rule-symbol")
};

const strengthBar = document.getElementById("strength-bar");
const strengthText = document.getElementById("strength-text");

// üëÅÔ∏è Mostrar / ocultar contrase√±a
togglePass.addEventListener("click", () => {
  if (regPassword.type === "password") {
    regPassword.type = "text";
    togglePass.textContent = "üôà";
  } else {
    regPassword.type = "password";
    togglePass.textContent = "üëÅÔ∏è";
  }
});

// Validaciones en tiempo real
regPassword.addEventListener("input", () => {
  const value = regPassword.value;

  const hasLength = value.length >= 8;
  const hasUpper = /[A-Z]/.test(value);
  const hasLower = /[a-z]/.test(value);
  const hasNumber = /\d/.test(value);
  const hasSymbol = /[^A-Za-z0-9]/.test(value);

  rules.length.style.color = hasLength ? "green" : "#555";
  rules.upper.style.color = hasUpper ? "green" : "#555";
  rules.lower.style.color = hasLower ? "green" : "#555";
  rules.number.style.color = hasNumber ? "green" : "#555";
  rules.symbol.style.color = hasSymbol ? "green" : "#555";

  let strength = 0;
  if (hasLength) strength++;
  if (hasUpper) strength++;
  if (hasLower) strength++;
  if (hasNumber) strength++;
  if (hasSymbol) strength++;

  if (strength <= 2) {
    strengthBar.style.width = "30%";
    strengthBar.style.background = "red";
    strengthText.textContent = "Fuerza: D√©bil";
  } else if (strength <= 4) {
    strengthBar.style.width = "70%";
    strengthBar.style.background = "orange";
    strengthText.textContent = "Fuerza: Media";
  } else {
    strengthBar.style.width = "100%";
    strengthBar.style.background = "green";
    strengthText.textContent = "Fuerza: Fuerte";
  }
});

document.getElementById('reg-btn').addEventListener('click', async ()=>{
  const u = document.getElementById('reg-username').value.trim();
  const p = document.getElementById('reg-password').value.trim();
  const msg = document.getElementById('auth-msg');

  const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z\d]).{8,}$/;

  if(!u || !p){
    msg.textContent = 'Completa usuario y contrase√±a';
    return;
  }

  if(!regex.test(p)){
    msg.textContent = 'La contrase√±a no cumple con los requisitos.';
    return;
  }

  const r = await api('/register','POST',{ username:u, password:p });

  if(!r){
    msg.textContent='Error servidor';
    return;
  }

  if(r.error){
    msg.textContent = r.error;
    return;
  }

  await initAfterAuth();
});


    async function checkSession(){ const r = await api('/me'); if(r && r.user){ await initAfterAuth(); } else { document.getElementById('auth').style.display='block'; document.getElementById('app').style.display='none'; } }

    async function initAfterAuth(){ const r = await api('/me'); if(!r || !r.user){ document.getElementById('auth').style.display='block'; document.getElementById('app').style.display='none'; return; }
      me = r.user; document.getElementById('me-name').textContent = me.username; document.getElementById('me-presence').textContent = 'En l√≠nea';
      if(me.avatar){ document.getElementById('me-avatar-img').src = me.avatar; document.getElementById('me-avatar-img').style.display='block'; document.getElementById('me-avatar-initial').style.display='none'; }
      if(me.description) document.getElementById('me-desc').textContent = me.description;
      document.getElementById('auth').style.display='none'; document.getElementById('app').style.display='flex';
      socket.emit('online', me.id);
      bindUI(); await refreshAll(); setInterval(refreshAll,5000);
    }

    function bindUI(){
      document.getElementById('add-contact-btn').onclick = async ()=>{
        const username = document.getElementById('add-contact-name').value.trim(); if(!username) return alert('Escribe un usuario');
        const r = await api('/add-contact','POST',{ to: username }); if(r && r.error) return alert(r.error); document.getElementById('add-contact-name').value=''; alert('Solicitud enviada');
      };

      document.getElementById('create-group-btn').onclick = async ()=>{ const name = document.getElementById('new-group-name').value.trim(); if(!name) return alert('Nombre requerido'); const r = await api('/groups/create','POST',{ name, members: [] }); if(r && r.error) return alert(r.error); document.getElementById('new-group-name').value=''; await loadGroups(); };

      document.getElementById('send-btn').onclick = sendMessage;
      document.getElementById('message-input').addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });

      document.getElementById('logout-btn').onclick = async ()=>{ await api('/logout','POST'); location.reload(); };

      document.getElementById('change-avatar').onclick = ()=>{ document.getElementById('avatar-file').click(); };
      document.getElementById('avatar-file').addEventListener('change', async (e)=>{
        const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = async ()=>{
          const dataUrl = reader.result; const r = await api('/me/profile','POST',{ avatar: dataUrl }); if(r && r.ok){ document.getElementById('me-avatar-img').src = dataUrl; document.getElementById('me-avatar-img').style.display='block'; document.getElementById('me-avatar-initial').style.display='none'; }
        }; reader.readAsDataURL(f);
      });

      document.getElementById('edit-desc').onclick = async ()=>{
        const desc = prompt('Escribe una descripci√≥n (visible en tu perfil):', document.getElementById('me-desc').textContent || '');
        if(desc!==null){ const r = await api('/me/profile','POST',{ description: desc }); if(r && r.ok){ document.getElementById('me-desc').textContent = desc; } }
      };

      document.getElementById('toggle-dark').onclick = ()=>{ document.body.classList.toggle('dark'); };

      // emoji picker
      const picker = document.getElementById('emoji-picker'); picker.innerHTML=''; EMOJIS.forEach(e=>{ const b=document.createElement('button'); b.textContent=e; b.style.border='none'; b.style.background='transparent'; b.style.fontSize='20px'; b.style.margin='4px'; b.onclick = ()=>{ const input = document.getElementById('message-input'); input.value += e; picker.style.display='none'; input.focus(); }; picker.appendChild(b); });
      document.getElementById('emoji-btn').onclick = ()=>{ const p = document.getElementById('emoji-picker'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; };
    }

    async function refreshAll(){ await loadContacts(); await loadGroups(); await updateUserCount(); }

    async function loadContacts(){ const cs = await api('/contacts'); const list = document.getElementById('contacts-list'); list.innerHTML='';
      // global
      const g = document.createElement('div'); g.className='item'; g.innerHTML = `<div style="width:40px"><div class="logo">G</div></div><div class="meta"><div class="title">Global</div><div class="small">Chat p√∫blico</div></div>`; g.onclick = ()=> openGlobal(); list.appendChild(g);

      // groups label
      const grpLabel = document.createElement('div'); grpLabel.className='small'; grpLabel.style.margin='8px 8px 4px 8px'; grpLabel.textContent='Grupos'; list.appendChild(grpLabel);

      // groups will be inserted by loadGroups to keep order
      // contacts label
      const contLabel = document.createElement('div'); contLabel.className='small'; contLabel.style.margin='8px 8px 4px 8px'; contLabel.textContent='Contactos'; list.appendChild(contLabel);

      if(Array.isArray(cs)){
        cs.forEach(c=>{
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `<div style="width:44px"><div class="me-avatar">${c.avatar?'<img src="'+c.avatar+'"/>':(c.username[0].toUpperCase())}</div></div><div class="meta"><div class="title">${c.username} ${c.online?'<span style="color:#34d859">‚óè</span>':''}</div><div class="small">${c.online? 'En l√≠nea' : 'Desconectado'}</div></div>`;
          el.onclick = ()=> openPrivate(c.id,c.username);
          list.appendChild(el);
        });
      }
    }

    async function loadGroups(){ const groups = await api('/groups'); if(!Array.isArray(groups)) return; const list = document.getElementById('contacts-list'); // remove existing group items
      Array.from(list.querySelectorAll('.group-item')).forEach(n=>n.remove());
      groups.forEach(g=>{
        const el = document.createElement('div'); el.className='item group-item'; el.innerHTML = `<div style="width:44px"><div class="me-avatar">#</div></div><div class="meta"><div class="title">${g.name}</div><div class="small">${g.members.length} miembros</div></div>`;
        el.onclick = ()=> openGroup(g.id,g.name);
        // insert before contacts label
        const contLabel = Array.from(list.children).find(ch => ch.textContent === 'Contactos');
        if(contLabel) list.insertBefore(el, contLabel);
        else list.appendChild(el);
      });
    }

    async function openGlobal(){ current = { type:'global' }; document.getElementById('chat-name').textContent='Global'; document.getElementById('chat-sub').textContent='Chat p√∫blico'; document.getElementById('messages').innerHTML=''; const msgs = await api('/messages'); if(Array.isArray(msgs)) msgs.forEach(render); scrollBottom(); socket.emit('join_group',0); }

    async function openPrivate(id,name){ current = { type:'private', withId:id }; document.getElementById('chat-name').textContent = name; document.getElementById('chat-sub').textContent = 'Chat privado'; document.getElementById('messages').innerHTML=''; const msgs = await api('/private/'+id); if(Array.isArray(msgs)) msgs.forEach(render); scrollBottom();  }

    async function openGroup(id,name){ current = { type:'group', id, name }; document.getElementById('chat-name').textContent = name; document.getElementById('chat-sub').textContent='Grupo'; document.getElementById('messages').innerHTML=''; const msgs = await api('/groups/messages/'+id); if(Array.isArray(msgs)) msgs.forEach(render); scrollBottom(); socket.emit('join_group', id); }
function render(m){
  const box = document.getElementById('messages');
  const el = document.createElement('div');

  const isMe =
    m.user_id === me.id ||
    m.from === me.id ||
    m.from_id === me.id;

  el.className = 'msg ' + (isMe ? 'me' : 'other');

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent =
    (m.username || m.fromName || 'Usuario') +
    ' ‚Ä¢ ' +
    new Date(m.created_at).toLocaleString();

  const body = document.createElement('div');

  // ‚úÖ SI ES ARCHIVO
  if(m.file_url){
    const ext = m.file_url.split('.').pop().toLowerCase();

    // üñºÔ∏è IMAGEN
    if(['jpg','jpeg','png','gif','webp'].includes(ext)){
      const img = document.createElement('img');
      img.src = m.file_url;
      img.style.maxWidth = "220px";
      img.style.borderRadius = "10px";
      img.style.marginTop = "6px";
      body.appendChild(img);
    }
    // üé• VIDEO
    else if(['mp4','webm','ogg'].includes(ext)){
      const video = document.createElement('video');
      video.src = m.file_url;
      video.controls = true;
      video.style.maxWidth = "240px";
      video.style.marginTop = "6px";
      body.appendChild(video);
    }
    // üìÑ DOCUMENTO
    else{
      const link = document.createElement('a');
      link.href = m.file_url;
      link.textContent = "üìÑ Descargar archivo";
      link.target = "_blank";
      link.style.display = "block";
      link.style.marginTop = "6px";
      body.appendChild(link);
    }
  }
  // ‚úÖ TEXTO NORMAL
  else{
    body.textContent = m.text || '';
  }

  el.appendChild(meta);
  el.appendChild(body);
  box.appendChild(el);
}



    function scrollBottom(){ const box=document.getElementById('messages'); setTimeout(()=>{ box.scrollTop = box.scrollHeight; },50); }

    async function sendMessage(){
  const input = document.getElementById('message-input');
  const fileInput = document.getElementById('file-input');
  const text = input.value.trim();
  const file = fileInput.files[0];

  // ‚úÖ SI SE ENV√çA ARCHIVO
  if(file){
    const formData = new FormData();
    formData.append("file", file);

    if(current.type === 'private'){
      formData.append("to", current.withId);
    }
    if(current.type === 'group'){
      formData.append("group_id", current.id);
    }

    await fetch("/api/upload", {
      method: "POST",
      body: formData
    });

    fileInput.value = "";
    return;
  }

  // ‚úÖ MENSAJE NORMAL
  if(!text) return;
  input.value = '';

  if(current.type==='global'){
    await api('/messages','POST',{ text });
  } 
  else if(current.type==='private'){
    await api('/private/send','POST',{ to: current.withId, text });
  } 
  else if(current.type==='group'){
    await api('/groups/send','POST',{ group_id: current.id, text });
  }
}
document.getElementById("file-btn").onclick = () => {
  document.getElementById("file-input").click();
};

    socket.on('message',(m)=>{ if(current.type==='global'){ render(m); scrollBottom(); } });
    socket.on('private_message', (m) => {
  if (current.type !== 'private') return;

  const otherId = current.withId;

  if (
    (m.from_id === me.id && m.to_id === otherId) ||
    (m.from_id === otherId && m.to_id === me.id)
  ) {
    render({
      ...m,
      user_id: m.from_id,
      username: m.from_id === me.id ? me.username : current.username
    });
    scrollBottom();
  }
});


    socket.on('group_message',(m)=>{ if(current.type==='group' && m.group_id===current.id){ render(m); scrollBottom(); } else { loadGroups(); } });
    socket.on('file_message', (m)=>{
  if(current.type === 'private' && 
    (m.from_id === current.withId || m.to_id === current.withId)){
    render(m);
    scrollBottom();
  }

  if(current.type === 'group' && m.group_id === current.id){
    render(m);
    scrollBottom();
  }
});

    socket.on('presence_update',(p)=>{ loadContacts(); updateUserCount(); });
    socket.on('friend_request',(d)=>{ // simple notification
      if(me && d.toId === me.id){ alert('Nueva solicitud de amistad de ' + d.fromName); }
    });

    async function updateUserCount(){ const cs = await api('/contacts'); const online = (cs||[]).filter(x=>x.online).length; document.getElementById('user-count').textContent = online + ' online'; }

    
    (async ()=>{ await checkSession(); })();

/* ============================
   MODO M√ìVIL TIPO WHATSAPP
   ============================ */
const sidebar = document.querySelector(".sidebar");
const overlay = document.getElementById("overlay");
const menuBtn = document.getElementById("mobile-menu-btn");

// Abrir sidebar
menuBtn.addEventListener("click", () => {
  sidebar.classList.add("open");
  overlay.classList.add("show");
});

// Cerrar al tocar fuera
overlay.addEventListener("click", () => {
  sidebar.classList.remove("open");
  overlay.classList.remove("show");
});

// Cerrar cuando entras a un chat
function closeSidebar(){
  sidebar.classList.remove("open");
  overlay.classList.remove("show");
}

// Reemplazo funciones para cerrar men√∫ al abrir chat
const originalOpenPrivate = openPrivate;
openPrivate = function(id, name){
  closeSidebar();
  originalOpenPrivate(id, name);
}

const originalOpenGroup = openGroup;
openGroup = function(id, name){
  closeSidebar();
  originalOpenGroup(id, name);
}

const originalOpenGlobal = openGlobal;
openGlobal = function(){
  closeSidebar();
  originalOpenGlobal();
}

</script>

  </script>
</body>
</html>
