<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatNodo ‚Äî WhatsApp Style</title>

  <link rel="stylesheet" href="/css/style.css" />

  <style>
    :root{
      --bg:#e9edef; --panel:#ffffff; --accent:#25D366; --muted:#8a9398;
      --me:#DCF8C6; --them:#ffffff; --header:#075E54; --text:#111827;
      --sidebar:#f6f6f6;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif}
    html,body,#app{height:100%;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    #app{height:100vh;display:none;align-items:stretch;gap:18px;padding:18px}

    .sidebar{width:340px;background:var(--sidebar);border-radius:12px;
      display:flex;flex-direction:column;overflow:hidden;
      box-shadow:0 6px 18px rgba(0,0,0,0.07)}
    .sidebar .top{display:flex;align-items:center;
      justify-content:space-between;padding:14px 16px;border-bottom:1px solid #e6e6e6}
    .brand{display:flex;gap:12px;align-items:center}
    .brand h1{font-size:20px;color:var(--header);font-weight:700}
    .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#cfe9d6,#8fd6a0);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}

    .search{padding:10px 14px;border-bottom:1px solid #eee}
    .search input{width:100%;padding:10px;border-radius:20px;border:1px solid #e5e5e5;background:#fff}

    .list{overflow:auto;padding:10px 8px;flex:1}
    .item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:8px;cursor:pointer}
    .item:hover{background:#f4f7f6}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.online{background:#34d859}
    .dot.offline{background:#cfcfcf}

    .chat{flex:1;display:flex;flex-direction:column;border-radius:12px;
      background:#fff;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .chat .head{display:flex;align-items:center;gap:12px;padding:14px;
      border-bottom:1px solid #eee;background:linear-gradient(90deg,var(--header),#128C7E);color:#fff}
    .chat .messages{flex:1;padding:18px;overflow:auto;background:#eaf3ee}
    .msg{max-width:72%;padding:10px 12px;border-radius:8px;margin-bottom:8px;
      box-shadow:0 1px 0 rgba(0,0,0,0.03)}
    .msg.me{margin-left:auto;background:var(--me)}
    .msg.other{background:var(--them)}
    .msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid #f0f0f0;align-items:center}

    .emoji-picker{position:absolute;right:40px;bottom:90px;background:#fff;
      padding:8px;border:1px solid #eee;border-radius:8px;
      box-shadow:0 8px 24px rgba(0,0,0,0.12);display:grid;
      grid-template-columns:repeat(8,1fr);gap:6px;z-index:50}

    /* AUTH BOX */
    #auth-box{
      max-width:320px;
      margin:40px auto;
      padding:20px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.1);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    #auth-box input{padding:10px;border:1px solid #ddd;border-radius:8px}
    #auth-box button{padding:10px;border:none;background:var(--header);
      color:#fff;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>

<!-- LOGIN + REGISTRO -->
<div id="auth-box">
  <h2>Accede o reg√≠strate</h2>

  <input id="login-user" placeholder="Usuario" />
  <input id="login-pass" type="password" placeholder="Contrase√±a" />
  <button onclick="login()">Iniciar sesi√≥n</button>

  <hr>

  <input id="reg-user" placeholder="Nuevo usuario" />
  <input id="reg-pass" type="password" placeholder="Contrase√±a" />
  <button onclick="register()">Registrarse</button>
</div>

<!-- APP -->
<div id="app">
  <aside class="sidebar">
    <div class="top">
      <div class="brand">
        <div class="avatar">CN</div>
        <div>
          <h1>ChatNodo</h1>
          <div style="font-size:12px;color:var(--muted)">Node + Socket.io</div>
        </div>
      </div>
    </div>

    <div class="search">
      <input id="search" placeholder="Buscar contactos o grupos..." />
    </div>

    <div style="padding:10px;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;gap:10px">
      <div class="avatar" id="me-avatar">ME</div>
      <div class="me-info">
        <div class="name" id="me-name">Invitado</div>
        <div class="small" id="me-presence">Desconectado</div>
      </div>
    </div>

    <div class="list" id="contacts-list"></div>
  </aside>

  <main class="chat">
    <div class="head">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="avatar" id="chat-avatar">G</div>
        <div>
          <div class="title" id="chat-name">Global</div>
          <div style="font-size:13px" id="chat-sub">Chat p√∫blico</div>
        </div>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="composer">
      <button id="emoji-btn">üòÄ</button>
      <input id="message-input" placeholder="Escribe un mensaje..." />
      <button id="send-btn">Enviar</button>
    </div>
  </main>
</div>

<div id="emoji-picker" class="emoji-picker" style="display:none"></div>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io();
let me = null;
let current = {type:"global"};

// API helper con sesi√≥n
async function api(path, method="GET", body){
  const opts = {
    method,
    headers:{},
    credentials:"include"
  };
  if(body){
    opts.headers["Content-Type"]="application/json";
    opts.body = JSON.stringify(body);
  }
  const r = await fetch("/api"+path, opts);
  return r.json();
}

/* LOGIN */
async function login(){
  const username = document.getElementById("login-user").value;
  const password = document.getElementById("login-pass").value;

  const r = await api("/login","POST",{ username, password });

  if(r.error) return alert(r.error);

  location.reload();
}

/* REGISTRO */
async function register(){
  const username = document.getElementById("reg-user").value;
  const password = document.getElementById("reg-pass").value;

  const r = await api("/register","POST",{ username, password });

  if(r.error) return alert(r.error);

  location.reload();
}

// Cargar usuario
async function loadMe(){
  const r = await api("/me");
  me = r.user;

  if(!me){
    document.getElementById("auth-box").style.display="flex";
    document.getElementById("app").style.display="none";
    return;
  }

  document.getElementById("auth-box").style.display="none";
  document.getElementById("app").style.display="flex";

  document.getElementById("me-name").textContent = me.username;
  document.getElementById("me-presence").textContent = "En l√≠nea";

  socket.emit("online", me.id);
}

/* CONTACTOS */
async function loadContacts(){
  const cs = me ? await api("/contacts") : [];
  const list = document.getElementById("contacts-list");
  list.innerHTML = "";

  let g = document.createElement("div");
  g.className="item";
  g.innerHTML = `<div class="meta"><div class="title">Global</div>
                 <div class="desc">Chat p√∫blico</div></div>`;
  g.onclick = openGlobal;
  list.appendChild(g);
}

/* GLOBAL CHAT */
async function loadGlobal(){
  current = {type:"global"};
  document.getElementById("chat-name").textContent="Global";
  document.getElementById("chat-sub").textContent="Chat p√∫blico";

  const msgs = await api("/messages");
  const box = document.getElementById("messages");
  box.innerHTML="";

  msgs.forEach(render);
}

/* RENDER MENSAJES */
function render(m){
  const box = document.getElementById("messages");
  const el = document.createElement("div");
  const isMe = me && (m.user_id===me.id || m.from===me.id);

  el.className="msg "+(isMe?"me":"other");

  el.innerHTML = `
    <div class="meta">${m.username || "User"} ‚Ä¢ 
    ${new Date(m.created_at).toLocaleString()}</div>
    <div>${m.text}</div>
  `;

  box.appendChild(el);
  box.scrollTop = box.scrollHeight;
}

/* ENVIAR */
async function sendMessage(){
  let text = document.getElementById("message-input").value;
  if(!text.trim()) return;
  
  const r = await api("/messages","POST",{text});
  render(r);

  document.getElementById("message-input").value="";
}

document.getElementById("send-btn").onclick = sendMessage;

/* SOCKET */
socket.on("message", render);

// INIT
(async ()=>{
  await loadMe();
  await loadContacts();
  await loadGlobal();
})();
</script>
</body>
</html>

