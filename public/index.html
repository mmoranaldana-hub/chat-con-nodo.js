<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat Node.js</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="app">

    <!-- LEFT SIDEBAR -->
    <div id="sidebar">
        <h2>Contactos</h2>
        <div id="contact-list"></div>

        <h2>Grupos</h2>
        <div id="group-list"></div>

        <h3>Agregar contacto</h3>
        <input id="add-contact-name" placeholder="Nombre usuario">
        <button onclick="addContact()">A√±adir</button>

        <h3>Crear grupo</h3>
        <input id="new-group-name" placeholder="Nombre del grupo">
        <input id="new-group-members" placeholder="Miembros (IDs separados por coma)">
        <button onclick="createGroup()">Crear</button>

        <button onclick="logout()">Cerrar sesi√≥n</button>
    </div>

    <!-- CHAT WINDOW -->
    <div id="chat">
        <div id="chat-header">
            <h2 id="chat-name">Selecciona un chat</h2>
            <span id="chat-sub"></span>
        </div>

        <div id="messages"></div>

        <div id="chat-input">
            <input id="msg" placeholder="Escribe un mensaje...">
            <button onclick="sendMsg()">Enviar</button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
let socket = io();
let myId = null;
let current = null;

function api(url, method="GET", data=null){
    return fetch("/api"+url, {
        method,
        headers: {"Content-Type":"application/json"},
        body: data ? JSON.stringify(data) : null
    }).then(r=>r.json());
}

/* -----------------------------
   LOGIN AUTOM√ÅTICO SI YA HAY SESI√ìN
----------------------------- */
api("/me").then(r=>{
    if(!r.user) return location.href="/login.html";
    myId = r.user.id;
    loadContacts();
    loadGroups();
    socket.emit("auth", {userId: myId});
});


/* -----------------------------
   CONTACTOS
----------------------------- */
function loadContacts(){
    api("/contacts").then(list=>{
        const box = document.getElementById("contact-list");
        box.innerHTML = "";
        list.forEach(c=>{
            const btn = document.createElement("button");
            btn.textContent = c.username + (c.online ? " üü¢" : " üî¥");
            btn.onclick = ()=> openPrivateChat(c.id, c.username);
            box.appendChild(btn);
        });
    });
}

function addContact(){
    const name = document.getElementById("add-contact-name").value.trim();
    if(!name) return alert("Escribe un nombre");

    api("/add-contact","POST",{to:name}).then(r=>{
        if(r.error) alert(r.error);
        else loadContacts();
    });
}


/* -----------------------------
   CHATS PRIVADOS
----------------------------- */
function openPrivateChat(id, name){
    current = {type:"private", id, name};
    document.getElementById("chat-name").textContent = name;
    document.getElementById("chat-sub").textContent = "Chat privado";

    api("/messages/"+id).then(msgs=>{
        const box = document.getElementById("messages");
        box.innerHTML = "";
        msgs.forEach(render);
        scrollBottom();
    });
}


/* -----------------------------
   GRUPOS
----------------------------- */

function loadGroups(){
    api("/groups").then(list=>{
        const box = document.getElementById("group-list");
        box.innerHTML = "";

        list.forEach(g=>{
            const btn = document.createElement("button");
            btn.textContent = g.name + " ("+g.members.length+")";
            btn.onclick = ()=>openGroup(g.id, g.name);
            box.appendChild(btn);
        });
    });
}

function createGroup(){
    const name = document.getElementById("new-group-name").value.trim();
    const raw = document.getElementById("new-group-members").value.trim();

    if(!name) return alert("Escribe nombre del grupo");

    let members = raw ? raw.split(",").map(n=>parseInt(n)) : [];

    api("/groups/create", "POST", {name, members}).then(r=>{
        if(r.ok){
            alert("Grupo creado");
            loadGroups();
        }
    });
}

function promoteToAdmin(groupId, userId){
    api("/groups/promote","POST",{groupId, targetId:userId}).then(r=>{
        if(r.error) alert(r.error);
        else{
            alert("Miembro promovido a administrador");
            loadGroupInfo(groupId);
        }
    });
}

function loadGroupInfo(groupId){
    api("/groups").then(groups=>{
        const g = groups.find(x=>x.id==groupId);
        if(!g) return;

        const box = document.getElementById("messages");
        box.innerHTML = `<h3>Miembros de ${g.name}</h3><br>`;

        g.members.forEach(m=>{
            const row = document.createElement("div");
            row.style.margin = "5px 0";
            row.innerHTML = `
                <strong>${m.username}</strong>
                ${m.is_admin ? "(Admin)" :
                `<button onclick="promoteToAdmin(${groupId}, ${m.id})">Hacer Admin</button>`}
            `;
            box.appendChild(row);
        });
    });
}

async function openGroup(id, name){
    current = {type:"group", id, name};
    document.getElementById("chat-name").textContent = name;
    document.getElementById("chat-sub").textContent = "Grupo";

    const box = document.getElementById("messages");
    box.innerHTML = "";

    loadGroupInfo(id);

    const msgs = await api("/groups/messages/"+id);
    msgs.forEach(render);

    scrollBottom();
    socket.emit("join_group", id);
}


/* -----------------------------
   ENVIAR MENSAJES
----------------------------- */

function sendMsg(){
    const text = document.getElementById("msg").value.trim();
    if(!text) return;

    if(!current){
        return alert("Selecciona un chat");
    }

    if(current.type==="private"){
        socket.emit("private_message", {
            from: myId,
            receiver: current.id,
            text
        });
        render({username:"Yo", message:text});
    }

    if(current.type==="group"){
        api("/groups/send","POST",{
            group_id: current.id,
            text
        });
    }

    document.getElementById("msg").value = "";
    scrollBottom();
}


/* -----------------------------
   RENDER DE MENSAJES
----------------------------- */

function render(m){
    const box = document.getElementById("messages");
    const div = document.createElement("div");
    div.innerHTML = `<b>${m.username}:</b> ${m.message}`;
    box.appendChild(div);
}

function scrollBottom(){
    const box = document.getElementById("messages");
    box.scrollTop = box.scrollHeight;
}


/* -----------------------------
   SOCKETS
----------------------------- */

socket.on("private_message", msg=>{
    if(current && current.type==="private" && current.id===msg.from){
        render(msg);
    }
});

socket.on("group_message", msg=>{
    if(current && current.type==="group" && current.id===msg.group_id){
        render({username:"Miembro", message:msg.text});
    }
});


/* -----------------------------
   LOGOUT
----------------------------- */
function logout(){
    api("/logout","POST").then(()=>{
        location.href="/login.html";
    });
}

</script>
</body>
</html>
