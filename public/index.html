<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatNodo ‚Äî Completo (SPA)</title>

  <style>
    :root{
      --bg:#e9edef; --panel:#ffffff; --accent:#25D366; --muted:#8a9398;
      --me:#DCF8C6; --them:#ffffff; --header:#075E54; --text:#111827;
      --sidebar:#f6f6f6;
    }
    [data-theme="dark"]{
      --bg:#0f1724; --panel:#0b1220; --accent:#2dd4bf; --muted:#93a3b2;
      --me:#244; --them:#07121a; --header:#021; --text:#e6eef6;
      --sidebar:#061226;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif}
    html,body{height:100%;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}

    /* layout */
    .container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:1200px;background:var(--panel);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.08);overflow:hidden;display:flex}
    /* left (sidebar) */
    .sidebar{width:340px;background:var(--sidebar);padding:12px;display:flex;flex-direction:column;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;padding:8px}
    .brand .logo{width:44px;height:44;border-radius:50%;background:linear-gradient(135deg,#cfe9d6,#8fd6a0);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .search input{width:100%;padding:10px;border-radius:20px;border:1px solid #e6e6e6;background:transparent}
    .profile{display:flex;align-items:center;gap:10px;padding:8px}
    .me-avatar{width:56px;height:56;border-radius:50%;background:#ddd;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .me-avatar img{width:100%;height:100%;object-fit:cover}
    .me-info .name{font-weight:700}
    .me-info .about{font-size:12px;color:var(--muted)}
    .profile-actions{display:flex;flex-direction:column;gap:6px;margin-left:auto}
    .list{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:6px}
    .item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;cursor:pointer}
    .item:hover{background:rgba(0,0,0,0.03)}
    .meta .title{font-weight:600}
    .meta .desc{font-size:12px;color:var(--muted)}
    .badge{background:#d33;color:#fff;padding:2px 6px;border-radius:12px;font-size:12px;margin-left:8px}

    /* right (chat) */
    .chat{flex:1;display:flex;flex-direction:column;background:var(--panel)}
    .chat .head{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid rgba(0,0,0,0.06);background:linear-gradient(90deg,var(--header),#128C7E);color:#fff}
    .messages{flex:1;overflow:auto;padding:18px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent),var(--bg)}
    .msg{max-width:72%;padding:10px 12px;border-radius:8px;margin-bottom:8px;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
    .msg.me{margin-left:auto;background:var(--me)}
    .msg.other{background:var(--them)}
    .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(0,0,0,0.06);align-items:center;background:var(--panel)}
    .composer input{flex:1;padding:10px;border-radius:20px;border:1px solid #e6e6e6;background:transparent;color:var(--text)}
    .btn{background:var(--header);color:#fff;border:none;padding:9px 14px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--header);border:1px solid rgba(255,255,255,0.12)}
    .small{font-size:12px;color:var(--muted)}

    /* modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--panel);padding:16px;border-radius:10px;min-width:320px;max-width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.2)}
    .checkbox-list{max-height:240px;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:6px}

    /* toast */
    .toast{position:fixed;right:20px;bottom:20px;background:#111;color:#fff;padding:10px 14px;border-radius:8px;z-index:70;box-shadow:0 8px 30px rgba(0,0,0,0.3)}

    @media(max-width:900px){
      .card{flex-direction:column}
      .sidebar{width:100%;order:2}
      .chat{order:1}
    }
  </style>
</head>
<body data-theme="">
  <div class="container" id="root">

    <!-- AUTH SCREEN (SPA) -->
    <div id="auth-screen" style="display:none">
      <div class="auth-box" style="max-width:420px;margin:auto">
        <h2 id="auth-title">Inicia sesi√≥n</h2>

        <div id="login-form">
          <input id="login-username" placeholder="Usuario" />
          <input id="login-password" type="password" placeholder="Contrase√±a" />
          <button class="btn" id="login-btn">Entrar</button>
          <div style="margin-top:12px;font-size:13px">
            ¬øNo tienes cuenta? <a href="#" id="show-register">Reg√≠strate</a>
          </div>
        </div>

        <div id="register-form" style="display:none">
          <input id="reg-username" placeholder="Usuario" />
          <input id="reg-password" type="password" placeholder="Contrase√±a" />
          <button class="btn" id="reg-btn">Crear cuenta</button>
          <div style="margin-top:12px;font-size:13px">
            ¬øYa tienes cuenta? <a href="#" id="show-login">Iniciar sesi√≥n</a>
          </div>
        </div>

        <div id="auth-msg" class="small" style="margin-top:10px;color:#b00"></div>
      </div>
    </div>

    <!-- APP (hidden until login) -->
    <div class="card" id="app" style="display:none">
      <!-- SIDEBAR -->
      <div class="sidebar">
        <div class="brand">
          <div class="logo">CN</div>
          <div>
            <div style="font-weight:700">ChatNodo</div>
            <div class="small">Node + Socket.io</div>
          </div>
        </div>

        <div class="search">
          <input id="search" placeholder="Buscar contactos o grupos..." />
        </div>

        <div class="profile">
          <div class="me-avatar" id="me-avatar"><span id="me-avatar-initial">ME</span></div>
          <div class="me-info">
            <div class="name" id="me-name">Invitado</div>
            <div class="about" id="me-about">Sin descripci√≥n</div>
          </div>
          <div class="profile-actions">
            <label style="font-size:12px;cursor:pointer">
              <input id="avatar-input" type="file" accept="image/*" style="display:none" />
              <span class="small btn.ghost" id="change-avatar">Cambiar foto</span>
            </label>
            <button class="small btn.ghost" id="edit-about">Editar descripci√≥n</button>
            <button class="small btn" id="theme-toggle">üåô</button>
          </div>
        </div>

        <div style="display:flex;gap:8px">
          <input id="add-contact-name" placeholder="Agregar contacto (usuario)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd" />
          <button class="btn" id="add-contact-btn">A√±adir</button>
        </div>

        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="new-group-name" placeholder="Crear grupo (nombre)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd" />
          <button class="btn" id="create-group-btn">Crear</button>
        </div>

        <div class="list" id="contacts-list">
          <!-- contactos y grupos -->
        </div>
      </div>

      <!-- CHAT -->
      <div class="chat">
        <div class="head">
          <div style="display:flex;align-items:center;gap:12px">
            <div class="me-avatar" id="chat-avatar">G</div>
            <div>
              <div style="font-weight:700" id="chat-name">Global</div>
              <div class="small" id="chat-sub">Chat p√∫blico</div>
            </div>
          </div>

          <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
            <div class="small" id="user-count">0 online</div>
            <button id="logout-btn" class="btn.ghost" style="background:#ffffff;border:1px solid #fff;color:#fff">Salir</button>
          </div>
        </div>

        <div class="messages" id="messages"></div>

        <div class="composer">
          <button id="emoji-toggle" class="btn.ghost">üòÄ</button>
          <input id="message-input" placeholder="Escribe un mensaje..." />
          <button id="send-btn" class="btn">Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="members-modal" style="display:none" class="modal-backdrop">
    <div class="modal">
      <h3>A√±adir miembros al grupo</h3>
      <div class="checkbox-list" id="members-checkboxes"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="members-cancel" class="btn.ghost">Cancelar</button>
        <button id="members-save" class="btn">A√±adir</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast-container"></div>

  <div id="emoji-picker" style="display:none;position:fixed;right:24px;bottom:80px;background:var(--panel);padding:10px;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.12)">
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    /* ========== CONFIG ========== */
    const socket = io();
    let me = null;
    let currentChat = { type: "global" }; // {type: "global"} | {type:"private", id:123, name:""} | {type:"group", id:123, name:""}
    const EMOJIS = ["üòÄ","üòÇ","üòç","üòÖ","üòé","üëç","üî•","‚ù§Ô∏è","üéâ","ü§ù","üëè","ü§ñ","üôå","üò¢","üò°","ü§©"];

    /* ===== API helper - include credentials ===== */
    async function api(path, method="GET", body) {
      const opts = {
        method,
        headers: {},
        credentials: "include"
      };
      if (body) {
        opts.headers["Content-Type"] = "application/json";
        opts.body = JSON.stringify(body);
      }
      const res = await fetch("/api" + path, opts);
      try { return await res.json(); } catch(e){ return null; }
    }

    /* ===== UI refs ===== */
    const authScreen = document.getElementById("auth-screen");
    const appEl = document.getElementById("app");
    const authMsg = document.getElementById("auth-msg");
    const toastContainer = document.getElementById("toast-container");
    const membersModal = document.getElementById("members-modal");
    const membersCheckboxes = document.getElementById("members-checkboxes");

    document.getElementById("show-register").addEventListener("click", (e)=>{ e.preventDefault(); toggleAuth(true); });
    document.getElementById("show-login").addEventListener("click", (e)=>{ e.preventDefault(); toggleAuth(false); });

    function toggleAuth(showRegister){
      document.getElementById("login-form").style.display = showRegister ? "none" : "block";
      document.getElementById("register-form").style.display = showRegister ? "block" : "none";
      document.getElementById("auth-title").textContent = showRegister ? "Reg√≠strate" : "Inicia sesi√≥n";
      authMsg.textContent = "";
    }

    /* ===== AUTH ===== */
    async function login(){
      authMsg.textContent = "";
      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value.trim();
      if(!username || !password){ authMsg.textContent = "Completa usuario y contrase√±a"; return; }
      const r = await api("/login","POST",{ username, password });
      if(!r) { authMsg.textContent = "Error del servidor"; return; }
      if(r.error){ authMsg.textContent = r.error; return; }
      await initAfterAuth();
    }

    async function register(){
      authMsg.textContent = "";
      const username = document.getElementById("reg-username").value.trim();
      const password = document.getElementById("reg-password").value.trim();
      if(!username || !password){ authMsg.textContent = "Completa usuario y contrase√±a"; return; }
      const r = await api("/register","POST",{ username, password });
      if(!r) { authMsg.textContent = "Error del servidor"; return; }
      if(r.error){ authMsg.textContent = r.error; return; }
      await initAfterAuth();
    }

    document.getElementById("login-btn").addEventListener("click", login);
    document.getElementById("reg-btn").addEventListener("click", register);

    /* ===== INITIAL FLOW: check session ===== */
    async function checkSession(){
      const r = await api("/me");
      if(r && r.user){
        await initAfterAuth();
      } else {
        // show auth
        authScreen.style.display = "block";
        appEl.style.display = "none";
      }
    }

    /* ===== after auth (either login/register or existing session) ===== */
    async function initAfterAuth(){
      // hide auth, show app
      authScreen.style.display = "none";
      appEl.style.display = "flex";

      // load me
      const r = await api("/me");
      me = r.user;
      document.getElementById("me-name").textContent = me.username;
      document.getElementById("me-about").textContent = (me.profile && me.profile.about) ? me.profile.about : "Sin descripci√≥n";

      // avatar
      if(me.profile && me.profile.avatar){
        const img = document.createElement("img");
        img.src = me.profile.avatar;
        const m = document.getElementById("me-avatar");
        m.innerHTML = "";
        m.appendChild(img);
        document.getElementById("me-avatar-initial").style.display = "none";
      } else {
        document.getElementById("me-avatar-initial").textContent = me.username[0].toUpperCase();
      }

      socket.emit("online", me.id);

      // setup UI listeners
      setupUI();

      // load contacts, groups, messages
      await reloadAll();
    }

    /* ===== UI setup ===== */
    function setupUI(){
      document.getElementById("add-contact-btn").onclick = async ()=>{
        const username = document.getElementById("add-contact-name").value.trim();
        if(!username) return alert("Escribe un nombre de usuario");
        // Use friend request flow (server will notify)
        const r = await api("/friend/request","POST",{ username });
        if(r && r.error) return alert(r.error);
        document.getElementById("add-contact-name").value = "";
        toast("Solicitud enviada a " + username);
      };

      document.getElementById("create-group-btn").onclick = async ()=>{
        const name = document.getElementById("new-group-name").value.trim();
        if(!name) return alert("Nombre requerido");
        const gr = await api("/groups/create","POST",{ name, members: [] });
        if(gr && gr.error) return alert(gr.error);
        document.getElementById("new-group-name").value = "";
        // now open modal to add members
        openMembersModal(gr.id);
      };

      document.getElementById("send-btn").onclick = sendMessage;
      document.getElementById("message-input").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendMessage(); });

      document.getElementById("emoji-toggle").onclick = ()=> {
        const picker = document.getElementById("emoji-picker");
        picker.style.display = (picker.style.display==="none"||!picker.style.display) ? "block" : "none";
      };

      document.getElementById("logout-btn").onclick = async ()=>{
        await api("/logout","POST");
        location.reload();
      };

      // avatar change
      document.getElementById("change-avatar").onclick = ()=> document.getElementById("avatar-input").click();
      document.getElementById("avatar-input").addEventListener("change", async (e)=>{
        const f = e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = async ()=> {
          const data = reader.result; // base64
          await api("/me/profile","POST",{ avatar: data });
          // refresh profile
          await initAfterAuth();
          toast("Avatar actualizado");
        };
        reader.readAsDataURL(f);
      });

      document.getElementById("edit-about").onclick = async ()=>{
        const about = prompt("Escribe tu descripci√≥n corta (estado):", me.profile ? me.profile.about || "" : "");
        if(about === null) return;
        await api("/me/profile","POST",{ about });
        await initAfterAuth();
        toast("Descripci√≥n actualizada");
      };

      // build emoji picker
      const picker = document.getElementById("emoji-picker");
      picker.innerHTML = "";
      EMOJIS.forEach(e=>{
        const d = document.createElement("button");
        d.textContent = e;
        d.style.border="none"; d.style.background="transparent"; d.style.fontSize="20px"; d.style.cursor="pointer"; d.style.margin="4px";
        d.onclick = ()=> {
          const input = document.getElementById("message-input");
          input.value += e;
          input.focus();
          picker.style.display = "none";
        };
        picker.appendChild(d);
      });

      // theme toggle
      const themeBtn = document.getElementById("theme-toggle");
      themeBtn.onclick = ()=>{
        const root = document.body;
        const dark = root.getAttribute("data-theme") === "dark";
        root.setAttribute("data-theme", dark ? "" : "dark");
        localStorage.setItem("chatnodo_dark", dark ? "0" : "1");
      };
      // apply saved theme
      if(localStorage.getItem("chatnodo_dark")==="1") document.body.setAttribute("data-theme","dark");
    }

    /* ===== Contacts & Groups ===== */
    async function loadContacts(){
      const cs = await api("/contacts");
      const list = document.getElementById("contacts-list");
      list.innerHTML = "";

      // global entry with unread check
      const unread = await api("/unread");
      const globalUnread = unread ? unread.global || 0 : 0;
      const g = document.createElement("div");
      g.className = "item";
      g.innerHTML = `<div style="width:40px"><div class="me-avatar">G</div></div>
        <div style="flex:1"><div class="title">Global ${globalUnread?('<span class="badge">'+globalUnread+'</span>'):''}</div><div class="desc">Chat p√∫blico</div></div>`;
      g.onclick = ()=> openGlobal();
      list.appendChild(g);

      // groups header
      const grpTitle = document.createElement("div");
      grpTitle.style.marginTop="8px";
      grpTitle.style.fontSize="13px";
      grpTitle.style.color="var(--muted)";
      grpTitle.textContent = "Grupos";
      list.appendChild(grpTitle);

      // contacts header
      const contTitle = document.createElement("div");
      contTitle.style.marginTop="8px";
      contTitle.style.fontSize="13px";
      contTitle.style.color="var(--muted)";
      contTitle.textContent = "Contactos";
      list.appendChild(contTitle);

      // append contacts
      if(Array.isArray(cs)){
        cs.forEach(c=>{
          const el = document.createElement("div");
          el.className = "item";
          el.innerHTML = `<div style="width:40px"><div class="me-avatar">${c.username[0].toUpperCase()}</div></div>
            <div style="flex:1"><div class="title">${c.username} ${c.online?'<span style="color:#34d859;font-size:12px">‚óè</span>':''}</div>
            <div class="desc">${c.online? 'En l√≠nea' : 'Desconectado'}</div></div>`;
          el.onclick = ()=> openPrivate(c.id, c.username);
          list.appendChild(el);
        });
      }
    }

    async function loadGroups(){
      const groups = await api("/groups");
      if(!Array.isArray(groups)) return;
      const list = document.getElementById("contacts-list");
      Array.from(list.querySelectorAll(".group-item")).forEach(n=>n.remove());

      const unread = await api("/unread");
      groups.forEach(g=>{
        const gid = g.id;
        const groupUnread = unread && unread.groups && unread.groups[gid] ? unread.groups[gid] : 0;
        const el = document.createElement("div");
        el.className = "item group-item";
        el.innerHTML = `<div style="width:40px"><div class="me-avatar">#</div></div>
          <div style="flex:1"><div class="title">${g.name} ${groupUnread?('<span class="badge">'+groupUnread+'</span>'):''}</div><div class="desc">${g.members.length} miembros</div></div>
          <div><button class="btn" onclick="openMembersModal(${g.id}, event)">Miembros</button></div>`;
        const contTitle = Array.from(list.children).find(ch => ch.textContent === "Contactos");
        if(contTitle) list.insertBefore(el, contTitle);
        else list.appendChild(el);
      });
    }

    /* ===== Members modal handling ===== */
    let currentGroupForModal = null;
    async function openMembersModal(groupId, evt){
      if(evt) evt.stopPropagation();
      currentGroupForModal = groupId;
      membersCheckboxes.innerHTML = "";
      // load contacts to choose from
      const contacts = await api("/contacts");
      contacts.forEach(c=>{
        const id = c.id;
        const label = document.createElement("label");
        label.style.display="flex"; label.style.alignItems="center"; label.style.gap="8px";
        const chk = document.createElement("input");
        chk.type = "checkbox"; chk.value = id;
        label.appendChild(chk);
        const span = document.createElement("span"); span.textContent = c.username;
        label.appendChild(span);
        membersCheckboxes.appendChild(label);
      });
      membersModal.style.display = "flex";
    }
    document.getElementById("members-cancel").onclick = ()=> { membersModal.style.display="none"; currentGroupForModal=null; };
    document.getElementById("members-save").onclick = async ()=>{
      const checks = Array.from(membersCheckboxes.querySelectorAll("input[type=checkbox]:checked")).map(x=>parseInt(x.value));
      if(checks.length===0){ membersModal.style.display="none"; currentGroupForModal=null; return; }
      for(const memberId of checks){
        await api("/groups/add-member","POST",{ group_id: currentGroupForModal, member_id: memberId });
      }
      membersModal.style.display="none";
      currentGroupForModal = null;
      toast("Miembros a√±adidos");
      loadGroups();
    };

    /* ===== CHAT operations ===== */
    async function openGlobal(){
      currentChat = { type:"global" };
      document.getElementById("chat-name").textContent = "Global";
      document.getElementById("chat-sub").textContent = "Chat p√∫blico";
      document.getElementById("messages").innerHTML = "";
      const msgs = await api("/messages");
      if(Array.isArray(msgs)) msgs.forEach(renderMessage);
      // mark as read
      await api("/messages/mark-read","POST",{});
      await updateUnreadUI();
      socket.emit("join_group", 0);
      scrollToBottom();
    }

    async function openPrivate(userId, username){
      currentChat = { type:"private", id: userId, name: username };
      document.getElementById("chat-name").textContent = username;
      document.getElementById("chat-sub").textContent = "Chat privado";
      document.getElementById("messages").innerHTML = "";
      const msgs = await api("/private/" + userId);
      if(Array.isArray(msgs)) msgs.forEach(renderMessage);
      // mark as read
      await api("/private/mark-read","POST",{ withId: userId });
      await updateUnreadUI();
      socket.emit("join_private", { me: me.id, other: userId });
      scrollToBottom();
    }

    async function openGroup(groupId, groupName){
      currentChat = { type:"group", id: groupId, name: groupName };
      document.getElementById("chat-name").textContent = groupName;
      document.getElementById("chat-sub").textContent = "Grupo";
      document.getElementById("messages").innerHTML = "";
      const msgs = await api("/groups/messages/" + groupId);
      if(Array.isArray(msgs)) msgs.forEach(renderMessage);
      // mark as read
      await api("/groups/mark-read","POST",{ group_id: groupId });
      await updateUnreadUI();
      socket.emit("join_group", groupId);
      scrollToBottom();
    }

    /* Render message (single function used by sockets) */
    function renderMessage(m){
      const box = document.getElementById("messages");
      const el = document.createElement("div");
      const isMe = me && ((m.user_id && m.user_id === me.id) || (m.from && m.from === me.id));
      el.className = "msg " + (isMe ? "me" : "other");
      const metaUser = m.username || m.fromName || (m.from ? ("User "+m.from) : "User");
      el.innerHTML = `<div class="meta">${metaUser} ‚Ä¢ ${new Date(m.created_at).toLocaleString()}</div><div>${escapeHtml(m.text)}</div>`;
      box.appendChild(el);
    }

    /* sendMessage - always use API and rely on socket to render to avoid duplicate */
    async function sendMessage(){
      const input = document.getElementById("message-input");
      const text = input.value.trim();
      if(!text) return;
      input.value = "";
      if(currentChat.type === "global"){
        await api("/messages","POST",{ text });
      } else if(currentChat.type === "private"){
        await api("/private/send","POST",{ to: currentChat.id, text });
      } else if(currentChat.type === "group"){
        await api("/groups/send","POST",{ group_id: currentChat.id, text });
      }
    }

    /* scroll util */
    function scrollToBottom(){
      const box = document.getElementById("messages");
      setTimeout(()=>{ box.scrollTop = box.scrollHeight; }, 100);
    }

    /* simple escape to avoid injection */
    function escapeHtml(unsafe) {
      if(!unsafe) return "";
      return unsafe.replace(/[&<"'>]/g, function(m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]);
      });
    }

    /* ===== SOCKET.IO listeners ===== */
    socket.on("connect", ()=>{
      console.log("socket connected");
    });

    socket.on("message", (m)=>{
      if(currentChat.type === "global"){
        renderMessage(m);
        scrollToBottom();
      }
      updateUnreadUI();
    });

    socket.on("private_message", (m)=>{
      const isRelevant = (currentChat.type === "private" && (m.from === currentChat.id || m.to === currentChat.id));
      if(isRelevant) {
        renderMessage(m);
        scrollToBottom();
      } else {
        updateUnreadUI();
        toast("Nuevo mensaje privado");
      }
    });

    socket.on("group_message", (m)=>{
      if(currentChat.type === "group" && m.group_id === currentChat.id){
        renderMessage(m);
        scrollToBottom();
      } else {
        updateUnreadUI();
        toast("Nuevo mensaje en grupo");
      }
    });

    socket.on("presence_update", (p)=>{
      loadContacts();
    });

    socket.on("friend_request", (p)=>{
      if(p.to === me.id){
        toast("Nueva solicitud de amistad de " + (p.from && p.from.username ? p.from.username : "alguien"));
      }
    });

    socket.on("friend_accepted", (p)=>{
      loadContacts();
      toast("Nueva amistad! ID: " + p.other);
    });

    socket.on("unread_update", ()=>{
      updateUnreadUI();
    });

    socket.on("group_member_added", ()=>{
      loadGroups();
      toast("Te a√±adieron a un grupo");
    });

    /* ===== unread UI update ===== */
    async function updateUnreadUI(){
      const unread = await api("/unread");
      // just reload contacts/groups (badges are generated there)
      await loadContacts();
      await loadGroups();
    }

    /* toast util */
    function toast(msg, time=3000){
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = msg;
      toastContainer.appendChild(t);
      setTimeout(()=> t.remove(), time);
    }

    /* helper: update user count (simple) */
    async function updateUserCount(){
      const cs = await api("/contacts");
      const online = (cs || []).filter(x => x.online).length;
      document.getElementById("user-count").textContent = online + " online";
    }

    /* ===== init ===== */
    (async ()=>{
      await checkSession();
      setInterval(()=>{ if(me){ loadContacts(); loadGroups(); updateUserCount(); } }, 5000);
    })();

    /* expose some functions for inline onclicks */
    window.openMembersModal = openMembersModal;

  </script>
</body>
</html>